name: Server Deploy
on:
  push:
    branches: ["main"] #, "develop"] # develop ë¸Œëžœì¹˜ ì¶”ê°€í•˜ë©´ ë³€ê²½
    paths:
      - '.github/workflows/deploy.yml'
      - 'src/**'
      - 'build.gradle'
      - 'gradle.properties'
      - 'Dockerfile'

concurrency:
  group: 'deploy-${{ github.ref_name }}' # ë¸Œëžœì¹˜ë³„ ë…ë¦½ì  ì‹¤í–‰
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: Build and Push Docker Image (dev) # develop ë¸Œëžœì¹˜ ì¶”ê°€í•˜ë©´ ${{ github.ref_name }}ë¡œ ë³€ê²½
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry ${{ env.REGISTRY }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=dev
#            type=raw,value=latest,enable=${{ github.ref_name == 'main' }}
#            type=raw,value=dev,enable=${{ github.ref_name == 'develop' }} # develop ë¸Œëžœì¹˜ ì¶”ê°€í•˜ë©´ í™œì„±í™”

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64 # x86ê³¼ arm64 ë™ì‹œ ë¹Œë“œ
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

  deploy-to-ec2:
    name: Deploy to EC2 (dev) # develop ë¸Œëžœì¹˜ ì¶”ê°€í•˜ë©´ ${{ github.ref_name }}ë¡œ ë³€ê²½
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    environment: dev # ${{ github.ref_name == 'main' && 'prod' || 'dev' }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_GHACTIONS_ROLE }}

      - name: Send SSM Run Command #TODO: ì¶”í›„ sha íƒœê·¸ë¡œ ìˆ˜ì •
        id: send-ssm-command
        run: |
          IMAGE=$(echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          TAG="dev"

          COMMANDS="[
                \"cd /home/ubuntu/ramble-be\",
                \"sudo -u ubuntu docker pull $IMAGE:$TAG\",
                \"sudo -u ubuntu docker-compose up -d --remove-orphans\",
                \"sudo -u ubuntu docker image prune -f\"
          ]"

          COMMAND_ID=$(aws ssm send-command \
              --instance-ids ${{ secrets.AWS_INSTANCE_ID }} \
              --document-name "AWS-RunShellScript" \
              --comment "Deploy Ramble BE (dev)" \
              --timeout-seconds 480 \
              --parameters "commands=$COMMANDS" \
              --output text \
              --query 'Command.CommandId')
          
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

      - name: Wait for Command Completion
        run: |
          aws ssm wait command-executed \
              --command-id ${{ steps.send-ssm-command.outputs.command_id }} \
              --instance-id ${{ secrets.AWS_INSTANCE_ID }}

      - name: Check Command Result
        if: always()
        run: |
          set +e
          
          RESULT=$(aws ssm get-command-invocation \
              --command-id ${{ steps.send-ssm-command.outputs.command_id }} \
              --instance-id ${{ secrets.AWS_INSTANCE_ID }} \
              --query '{Status:Status, StdOut:StandardOutputContent, StdErr:StandardErrorContent}' \
              --output json)
      
          STATUS=$(echo "$RESULT" | jq -r '.Status')
          STDOUT=$(echo "$RESULT" | jq -r '.StdOut')
          STDERR=$(echo "$RESULT" | jq -r '.StdErr')
          
          MAX_LEN=5000
          [ ${#STDOUT} -gt $MAX_LEN ] && STDOUT="${STDOUT:0:$MAX_LEN}\n\n... (ì¶œë ¥ ìƒëžµ, ì „ì²´ëŠ” EC2ì—ì„œ í™•ì¸)"
          [ ${#STDERR} -gt $MAX_LEN ] && STDERR="${STDERR:0:$MAX_LEN}\n\n... (ì¶œë ¥ ìƒëžµ, ì „ì²´ëŠ” EC2ì—ì„œ í™•ì¸)"
        
          declare -A ICONS=(["Success"]="ðŸŸ¢" ["Failed"]="ðŸ”´" ["Cancelled"]="ðŸ”´" ["TimedOut"]="ðŸŸ ")
          STATUS_BADGE="${ICONS[$STATUS]:-ðŸŸ¡} $STATUS"
          
          echo "ë°°í¬ ê²°ê³¼: $STATUS"
          
          echo "## SSM Command Execution Result (Dev)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| í•­ëª© | ë‚´ìš© |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | $STATUS_BADGE |" >> $GITHUB_STEP_SUMMARY
          echo "| **Command ID** | \`${{ steps.send-ssm-command.outputs.command_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Instance ID** | \`${{ secrets.AWS_INSTANCE_ID }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered By** | \`@${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Execution Time** | $(date '+%Y-%m-%d %H:%M:%S %Z') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“¤ Standard Output" >> $GITHUB_STEP_SUMMARY
          
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${STDOUT:-_No output_}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
    
          echo "### âš ï¸ Standard Error" >> $GITHUB_STEP_SUMMARY
          
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${STDERR:-_No errors_}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$STATUS" != "Success" ]; then
            exit 1
          fi
